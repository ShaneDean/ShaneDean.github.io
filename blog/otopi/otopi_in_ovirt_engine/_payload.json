[{"data":1,"prerenderedAt":329},["Reactive",2],{"content-query-UmnyqBu1P4":3},{"_path":4,"_dir":5,"_draft":6,"_partial":6,"_locale":7,"title":8,"description":7,"body":9,"_type":324,"_id":325,"_source":326,"_file":327,"_extension":328},"/blog/otopi/otopi_in_ovirt_engine","otopi",false,"","ovirt-engine中otopi的使用",{"type":10,"children":11,"toc":313},"root",[12,19,25,31,36,41,46,56,62,67,72,80,85,93,104,113,118,126,131,138,143,149,154,162,167,172,180,185,190,195,200,205,212,217,224,229,237,242,248,253,259,264,272,277,285,290,295,300,305],{"type":13,"tag":14,"props":15,"children":16},"element","h1",{"id":8},[17],{"type":18,"value":8},"text",{"type":13,"tag":20,"props":21,"children":23},"h2",{"id":22},"前言",[24],{"type":18,"value":22},{"type":13,"tag":26,"props":27,"children":28},"p",{},[29],{"type":18,"value":30},"oVirt项目的几个关键组件如engine、vdsm，都是通过otopi来完成install、config、uninstall的。",{"type":13,"tag":26,"props":32,"children":33},{},[34],{"type":18,"value":35},"本篇重点介绍ovirt-engine是如何使用otopi的。",{"type":13,"tag":20,"props":37,"children":39},{"id":38},"engine的脚本",[40],{"type":18,"value":38},{"type":13,"tag":26,"props":42,"children":43},{},[44],{"type":18,"value":45},"在完成ovirt-engine开发环境构建之后，在${PREFIX}/bin/目录下面，有一些可执行的脚步，其中包括engine-setup、engine-cleanup、engine-config等会经常使用的脚步。",{"type":13,"tag":47,"props":48,"children":50},"pre",{"code":49},"ls -al\n//连接关系  ： engine-setup  ->    xxxxx/ovirt-engine-setup\n",[51],{"type":13,"tag":52,"props":53,"children":54},"code",{"__ignoreMap":7},[55],{"type":18,"value":49},{"type":13,"tag":57,"props":58,"children":60},"h3",{"id":59},"ovirt-engine-setup",[61],{"type":18,"value":59},{"type":13,"tag":26,"props":63,"children":64},{},[65],{"type":18,"value":66},"这是一个shell脚步，它的作用是准备setup的环境(ovirt-engine-setup.env)和参数(baseenv)，我们也可以通过 --help来查看我们可以传递进去的一些选项。",{"type":13,"tag":26,"props":68,"children":69},{},[70],{"type":18,"value":71},"命令的最终是执行",{"type":13,"tag":47,"props":73,"children":75},{"code":74},"exec \"${otopidir}/otopi\" \"${baseenv} ${environment} ${otopienv}\"\n",[76],{"type":13,"tag":52,"props":77,"children":78},{"__ignoreMap":7},[79],{"type":18,"value":74},{"type":13,"tag":26,"props":81,"children":82},{},[83],{"type":18,"value":84},"在engine的packaging/setup目录下还提供了两个相关的重要内容。",{"type":13,"tag":47,"props":86,"children":88},{"code":87},"ovirt_engine_setup  // python module\nplugins             // otopi中定义的插件\n",[89],{"type":13,"tag":52,"props":90,"children":91},{"__ignoreMap":7},[92],{"type":18,"value":87},{"type":13,"tag":26,"props":94,"children":95},{},[96,102],{"type":13,"tag":97,"props":98,"children":99},"strong",{},[100],{"type":18,"value":101},"ovirt_engine_setup",{"type":18,"value":103},"模块的功能提供给plugins目录下面的插件所使用。",{"type":13,"tag":26,"props":105,"children":106},{},[107],{"type":13,"tag":108,"props":109,"children":112},"img",{"alt":110,"src":111},"image","https://github.com/ShaneDean/file/blob/master/blog/ovirt_engine_env/ovirt_engine_packages_setup_plugins_list.png?raw=true",[],{"type":13,"tag":26,"props":114,"children":115},{},[116],{"type":18,"value":117},"对应的关系是",{"type":13,"tag":47,"props":119,"children":121},{"code":120},"./plugins/${groups}/[${directory}]/${plugins}/__init__.py\n",[122],{"type":13,"tag":52,"props":123,"children":124},{"__ignoreMap":7},[125],{"type":18,"value":120},{"type":13,"tag":26,"props":127,"children":128},{},[129],{"type":18,"value":130},"每个_ _ init _ _.py文件里面定义了plugin",{"type":13,"tag":26,"props":132,"children":133},{},[134],{"type":13,"tag":108,"props":135,"children":137},{"alt":110,"src":136},"https://github.com/ShaneDean/file/blob/master/blog/ovirt_engine_env/ovirt_engine_packages_setup_plugins_plugin_createPlugins.png?raw=true",[],{"type":13,"tag":26,"props":139,"children":140},{},[141],{"type":18,"value":142},"所以最后都会通过otopi的context.registerPlugin来保存全部加载到的context变量_plugins中。",{"type":13,"tag":57,"props":144,"children":146},{"id":145},"engine-setup-log",[147],{"type":18,"value":148},"engine-setup log",{"type":13,"tag":26,"props":150,"children":151},{},[152],{"type":18,"value":153},"执行",{"type":13,"tag":47,"props":155,"children":157},{"code":156},"./bin/engine-setup --log=./engine-setup.log\n",[158],{"type":13,"tag":52,"props":159,"children":160},{"__ignoreMap":7},[161],{"type":18,"value":156},{"type":13,"tag":26,"props":163,"children":164},{},[165],{"type":18,"value":166},"无论配置过程成功或失败，我们可以查看engine-setup.log文件。其中里面包含了 ENVIRONMENT 和 SEQUENCE的dump信息。\nENOVIRONMENT包含了各类环境变量。\nSEQUENCE里面就根据不同的阶段显示了所有需要执行的各类方法。",{"type":13,"tag":26,"props":168,"children":169},{},[170],{"type":18,"value":171},"SEQUENCE 显示结构如下所示",{"type":13,"tag":47,"props":173,"children":175},{"code":174},"STAGE  ${Stages.STAGE_XXXX}\n    METHOD  otopi.plugins.${groups}.[${directory}].${plugin}.Plugin.${method}\n    METHOD  otopi.plugins.${groups}.[${directory}].${plugin}.Plugin.${method}\n",[176],{"type":13,"tag":52,"props":177,"children":178},{"__ignoreMap":7},[179],{"type":18,"value":174},{"type":13,"tag":26,"props":181,"children":182},{},[183],{"type":18,"value":184},"我们可以根据对应的关键信息在engine项目中找到对应的实现代码。",{"type":13,"tag":57,"props":186,"children":188},{"id":187},"debug",[189],{"type":18,"value":187},{"type":13,"tag":26,"props":191,"children":192},{},[193],{"type":18,"value":194},"使用调试工具可以帮助我们分析代码、理解原理。",{"type":13,"tag":26,"props":196,"children":197},{},[198],{"type":18,"value":199},"下面介绍如何调试 engine-setup程序",{"type":13,"tag":26,"props":201,"children":202},{},[203],{"type":18,"value":204},"使用Pycharm导入otopi项目\n新建一个Run/Debug Configurations",{"type":13,"tag":26,"props":206,"children":207},{},[208],{"type":13,"tag":108,"props":209,"children":211},{"alt":110,"src":210},"https://github.com/ShaneDean/file/blob/master/blog/ovirt_engine_env/otopi-debug-ovirt-engine-setup.png?raw=true",[],{"type":13,"tag":26,"props":213,"children":214},{},[215],{"type":18,"value":216},"图中标号：",{"type":13,"tag":218,"props":219,"children":221},"h4",{"id":220},"_1",[222],{"type":18,"value":223},"1",{"type":13,"tag":26,"props":225,"children":226},{},[227],{"type":18,"value":228},"otopi 的入口是 otopi/src/bin/otopi的shell，最终执行",{"type":13,"tag":47,"props":230,"children":232},{"code":231},"exec \"${OTOPI_PYTHON}\" -B -m otopi.__main__ \"${extraenv} $*\"\n",[233],{"type":13,"tag":52,"props":234,"children":235},{"__ignoreMap":7},[236],{"type":18,"value":231},{"type":13,"tag":26,"props":238,"children":239},{},[240],{"type":18,"value":241},"此处我们直接使用新建一个python 的run/debug ，入口程序就是exec python -B -m 后面对应的otopi._ _ main__",{"type":13,"tag":218,"props":243,"children":245},{"id":244},"_2",[246],{"type":18,"value":247},"2",{"type":13,"tag":26,"props":249,"children":250},{},[251],{"type":18,"value":252},"ovirt-engine项目中的engine-setup已经指定了传给otopi的参数，也可以在exec前面增加echo来查看",{"type":13,"tag":218,"props":254,"children":256},{"id":255},"_3",[257],{"type":18,"value":258},"3",{"type":13,"tag":26,"props":260,"children":261},{},[262],{"type":18,"value":263},"增加",{"type":13,"tag":47,"props":265,"children":267},{"code":266},"OTOPI_DEBUG = 1 \n",[268],{"type":13,"tag":52,"props":269,"children":270},{"__ignoreMap":7},[271],{"type":18,"value":266},{"type":13,"tag":26,"props":273,"children":274},{},[275],{"type":18,"value":276},"由于engine-setup执行的过程中import了部分engine里面的python lib, 地址如下：",{"type":13,"tag":47,"props":278,"children":280},{"code":279},"ovirt-engine/packaging/setup/ovirt_engine_setup\novirt-engine/packaging/pythonlib/ovirt-engine\n",[281],{"type":13,"tag":52,"props":282,"children":283},{"__ignoreMap":7},[284],{"type":18,"value":279},{"type":13,"tag":26,"props":286,"children":287},{},[288],{"type":18,"value":289},"需要相应的修改 PYTHONPATH",{"type":13,"tag":26,"props":291,"children":292},{},[293],{"type":18,"value":294},"这样就可以执行调试了",{"type":13,"tag":20,"props":296,"children":298},{"id":297},"为engine脚本添加一个plugin来完成指定工作",[299],{"type":18,"value":297},{"type":13,"tag":26,"props":301,"children":302},{},[303],{"type":18,"value":304},"首先需要明确需要完成哪些功能，明白是哪个阶段来做这个工作",{"type":13,"tag":47,"props":306,"children":308},{"code":307},"//todo\n",[309],{"type":13,"tag":52,"props":310,"children":311},{"__ignoreMap":7},[312],{"type":18,"value":307},{"title":7,"searchDepth":314,"depth":314,"links":315},2,[316,317,323],{"id":22,"depth":314,"text":22},{"id":38,"depth":314,"text":38,"children":318},[319,321,322],{"id":59,"depth":320,"text":59},3,{"id":145,"depth":320,"text":148},{"id":187,"depth":320,"text":187},{"id":297,"depth":314,"text":297},"markdown","content:blog:otopi:otopi_in_ovirt_engine.md","content","blog/otopi/otopi_in_ovirt_engine.md","md",1718158598647]