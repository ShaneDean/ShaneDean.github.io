{"_path":"/blog/otopi/otopi_in_ovirt_engine","_dir":"otopi","_draft":false,"_partial":false,"_locale":"","title":"ovirt-engine中otopi的使用","description":"","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"ovirt-engine中otopi的使用"},"children":[{"type":"text","value":"ovirt-engine中otopi的使用"}]},{"type":"element","tag":"h2","props":{"id":"前言"},"children":[{"type":"text","value":"前言"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"oVirt项目的几个关键组件如engine、vdsm，都是通过otopi来完成install、config、uninstall的。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"本篇重点介绍ovirt-engine是如何使用otopi的。"}]},{"type":"element","tag":"h2","props":{"id":"engine的脚本"},"children":[{"type":"text","value":"engine的脚本"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在完成ovirt-engine开发环境构建之后，在${PREFIX}/bin/目录下面，有一些可执行的脚步，其中包括engine-setup、engine-cleanup、engine-config等会经常使用的脚步。"}]},{"type":"element","tag":"pre","props":{"code":"ls -al\n//连接关系  ： engine-setup  ->    xxxxx/ovirt-engine-setup\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"ls -al\n//连接关系  ： engine-setup  ->    xxxxx/ovirt-engine-setup\n"}]}]},{"type":"element","tag":"h3","props":{"id":"ovirt-engine-setup"},"children":[{"type":"text","value":"ovirt-engine-setup"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这是一个shell脚步，它的作用是准备setup的环境(ovirt-engine-setup.env)和参数(baseenv)，我们也可以通过 --help来查看我们可以传递进去的一些选项。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"命令的最终是执行"}]},{"type":"element","tag":"pre","props":{"code":"exec \"${otopidir}/otopi\" \"${baseenv} ${environment} ${otopienv}\"\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"exec \"${otopidir}/otopi\" \"${baseenv} ${environment} ${otopienv}\"\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在engine的packaging/setup目录下还提供了两个相关的重要内容。"}]},{"type":"element","tag":"pre","props":{"code":"ovirt_engine_setup  // python module\nplugins             // otopi中定义的插件\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"ovirt_engine_setup  // python module\nplugins             // otopi中定义的插件\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"ovirt_engine_setup"}]},{"type":"text","value":"模块的功能提供给plugins目录下面的插件所使用。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"image","src":"https://github.com/ShaneDean/file/blob/master/blog/ovirt_engine_env/ovirt_engine_packages_setup_plugins_list.png?raw=true"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"对应的关系是"}]},{"type":"element","tag":"pre","props":{"code":"./plugins/${groups}/[${directory}]/${plugins}/__init__.py\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"./plugins/${groups}/[${directory}]/${plugins}/__init__.py\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"每个_ _ init _ _.py文件里面定义了plugin"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"image","src":"https://github.com/ShaneDean/file/blob/master/blog/ovirt_engine_env/ovirt_engine_packages_setup_plugins_plugin_createPlugins.png?raw=true"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"所以最后都会通过otopi的context.registerPlugin来保存全部加载到的context变量_plugins中。"}]},{"type":"element","tag":"h3","props":{"id":"engine-setup-log"},"children":[{"type":"text","value":"engine-setup log"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"执行"}]},{"type":"element","tag":"pre","props":{"code":"./bin/engine-setup --log=./engine-setup.log\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"./bin/engine-setup --log=./engine-setup.log\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"无论配置过程成功或失败，我们可以查看engine-setup.log文件。其中里面包含了 ENVIRONMENT 和 SEQUENCE的dump信息。\nENOVIRONMENT包含了各类环境变量。\nSEQUENCE里面就根据不同的阶段显示了所有需要执行的各类方法。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"SEQUENCE 显示结构如下所示"}]},{"type":"element","tag":"pre","props":{"code":"STAGE  ${Stages.STAGE_XXXX}\n    METHOD  otopi.plugins.${groups}.[${directory}].${plugin}.Plugin.${method}\n    METHOD  otopi.plugins.${groups}.[${directory}].${plugin}.Plugin.${method}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"STAGE  ${Stages.STAGE_XXXX}\n    METHOD  otopi.plugins.${groups}.[${directory}].${plugin}.Plugin.${method}\n    METHOD  otopi.plugins.${groups}.[${directory}].${plugin}.Plugin.${method}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我们可以根据对应的关键信息在engine项目中找到对应的实现代码。"}]},{"type":"element","tag":"h3","props":{"id":"debug"},"children":[{"type":"text","value":"debug"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"使用调试工具可以帮助我们分析代码、理解原理。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"下面介绍如何调试 engine-setup程序"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"使用Pycharm导入otopi项目\n新建一个Run/Debug Configurations"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"image","src":"https://github.com/ShaneDean/file/blob/master/blog/ovirt_engine_env/otopi-debug-ovirt-engine-setup.png?raw=true"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"图中标号："}]},{"type":"element","tag":"h4","props":{"id":"_1"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"otopi 的入口是 otopi/src/bin/otopi的shell，最终执行"}]},{"type":"element","tag":"pre","props":{"code":"exec \"${OTOPI_PYTHON}\" -B -m otopi.__main__ \"${extraenv} $*\"\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"exec \"${OTOPI_PYTHON}\" -B -m otopi.__main__ \"${extraenv} $*\"\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"此处我们直接使用新建一个python 的run/debug ，入口程序就是exec python -B -m 后面对应的otopi._ _ main__"}]},{"type":"element","tag":"h4","props":{"id":"_2"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ovirt-engine项目中的engine-setup已经指定了传给otopi的参数，也可以在exec前面增加echo来查看"}]},{"type":"element","tag":"h4","props":{"id":"_3"},"children":[{"type":"text","value":"3"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"增加"}]},{"type":"element","tag":"pre","props":{"code":"OTOPI_DEBUG = 1 \n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"OTOPI_DEBUG = 1 \n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"由于engine-setup执行的过程中import了部分engine里面的python lib, 地址如下："}]},{"type":"element","tag":"pre","props":{"code":"ovirt-engine/packaging/setup/ovirt_engine_setup\novirt-engine/packaging/pythonlib/ovirt-engine\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"ovirt-engine/packaging/setup/ovirt_engine_setup\novirt-engine/packaging/pythonlib/ovirt-engine\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"需要相应的修改 PYTHONPATH"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"这样就可以执行调试了"}]},{"type":"element","tag":"h2","props":{"id":"为engine脚本添加一个plugin来完成指定工作"},"children":[{"type":"text","value":"为engine脚本添加一个plugin来完成指定工作"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"首先需要明确需要完成哪些功能，明白是哪个阶段来做这个工作"}]},{"type":"element","tag":"pre","props":{"code":"//todo\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"//todo\n"}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"前言","depth":2,"text":"前言"},{"id":"engine的脚本","depth":2,"text":"engine的脚本","children":[{"id":"ovirt-engine-setup","depth":3,"text":"ovirt-engine-setup"},{"id":"engine-setup-log","depth":3,"text":"engine-setup log"},{"id":"debug","depth":3,"text":"debug"}]},{"id":"为engine脚本添加一个plugin来完成指定工作","depth":2,"text":"为engine脚本添加一个plugin来完成指定工作"}]}},"_type":"markdown","_id":"content:blog:otopi:otopi_in_ovirt_engine.md","_source":"content","_file":"blog/otopi/otopi_in_ovirt_engine.md","_extension":"md"}