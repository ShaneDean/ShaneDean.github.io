{"_path":"/blog/ovirt/engine/spec","_dir":"engine","_draft":false,"_partial":false,"_locale":"","title":"ovirt-engine spec","description":"","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"ovirt-engine-spec"},"children":[{"type":"text","value":"ovirt-engine spec"}]},{"type":"element","tag":"h2","props":{"id":"前言"},"children":[{"type":"text","value":"前言"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"以 ovirt-enigne-4.3为例，分析engine是如何打包成 rpm 的。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://rpm.org/user_doc/macros.html","rel":["nofollow"]},"children":[{"type":"text","value":"spec-macro"}]},{"type":"text","value":","}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://rpm-packaging-guide.github.io/","rel":["nofollow"]},"children":[{"type":"text","value":"rpm-package-guide"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"http://ftp.rpm.org/max-rpm/index.html","rel":["nofollow"]},"children":[{"type":"text","value":"maximum-rpm"}]}]},{"type":"element","tag":"h2","props":{"id":"rpm"},"children":[{"type":"text","value":"rpm"}]},{"type":"element","tag":"h2","props":{"id":"spec"},"children":[{"type":"text","value":"spec"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"spec 文件是rpmbuild的工作手册，手册里面定义了构建系统在各个阶段中执行的命令。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"spec文件由不同的条目组成，具体如下："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"注释    comments    人类阅读使用，rpm会忽略"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"标签    tags        定义数据"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"脚本    scripts     包含了特定时间执行的命令"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"宏      macros"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%files列表          pkg需要包含的文件列表"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"指令    directives  处理%files列表的方式"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"条件    conditionals    执行系统、架构相关的预处理工作"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"注释："}]},{"type":"element","tag":"pre","props":{"code":"# 后面的内容\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# 后面的内容\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"注释也可以展开 但需要使用%%进行转义"}]},{"type":"element","tag":"h3","props":{"id":"标签-tags"},"children":[{"type":"text","value":"标签 tags"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"格式"}]},{"type":"element","tag":"pre","props":{"code":"<something>:<something-else>\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"<something>:<something-else>\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"somethin"}]},{"type":"text","value":" 大小写、距离 都不敏感"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"内置："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Preamble    变量，Package Naming Tags\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Name        包名"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Version     包版本"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Release     发布次数，每次发布递增，新版本产生式时重置为1，1%{?dist}"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Summary"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"License     license版权"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"URL"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Source0     上游的源代码，应当是远程可靠的访问地址"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Patch0      上游补丁，应当是远程可靠的访问地址"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"BuildArch   如果pkg架构无关，则为noarch，如果相关则为架构缩写"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"BuildRequires   构建依赖"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Requires    运行依赖"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"ExcludeArch 不支持架构"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Body        指令集合， Descriptive Tags\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%description    包描述内容"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%files          会被install的文件列表"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%changelog      发型记录"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"脚本-script"},"children":[{"type":"text","value":"脚本 script"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"分类"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%prep           一系列命令来准备软件的构建环境"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%build          一系列命令来执行软件的构建"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%install        一系列命令来完成从%builddir到%buildroot目录的拷贝 （这里只有在创建pkg的时候，不是实际的用户环境的安装过程）"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%check          一些列命令来测试软件，比如包括 unit test case"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%pre            在安装pkg之前执行"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%post           在安装pkg之后执行"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%preun          在卸载pkg之前执行"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%postun         在卸载pkg之后执行"}]}]},{"type":"element","tag":"h3","props":{"id":"宏-macro"},"children":[{"type":"text","value":"宏 macro"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"spec内置2个简单的宏来执行特定的任务"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%setup      用来解压源代码，需要SOURCE"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%patch      用来给代码打补丁, 需要PATCH"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"同时用户可以自己定义宏， 包含两种宏。"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Simple Macros : 直接的文本替换"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Parameterized Macros ： 包含选项字段，将下一行用空格分隔的字段设为args"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"定义"}]},{"type":"element","tag":"pre","props":{"code":"%define <name>[(opts)] <body>\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"%define <name>[(opts)] <body>\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"包围body的空格都会被移除。 name 可以是字母数字和_组成，长度最少是3个字符。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果没有opts,macro只执行展开操作。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果opts中有参数的话，它的处理方式是"},{"type":"element","tag":"a","props":{"href":"https://linux.die.net/man/3/getopt","rel":["nofollow"]},"children":[{"type":"text","value":"getopt"}]},{"type":"text","value":"。宏中的可用变量是："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%0      被调用宏的名称"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%*      所有参数，不包括处理标志"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%**     所有参数，包括处理标志"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%#      参数数量"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{-f}   调用出现时,标志f的本身"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{-f*}  调用出现时,标志f指向的参数"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%1, %2  参数本身"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"无参数宏的情况下上面的变量都会废弃。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"%{flag} 取flag"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"%{?flag:X} 如果flag出现则为falg,不出现则为X"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"%{!?flag:X} 和上面相反"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"%(shell command) 执行结果即输出 ， 如%(date +%%y%%m%%d) ，这里的%%转义为命令执行中的% 避免再次展开"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"下面是可用来执行内嵌宏"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%trace          打印扩展前后的调试信息"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%dump           打印可用宏列表"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%getncpus       可用cpu数量"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%dnl            放弃下一行，不展开(>=4.15.0)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{echo:...}     打印到stdout"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{warn:...}     打印到stderr"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{error:...}    打印到stderr，并报错"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%define ...     定义宏，lazy展开"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%undefine ...   取消宏定义"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%global ...     定义全局可用宏 ， eager展开"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{load:...}     加载宏文件(>=4.12.0)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{expand:...}   再次展开"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{shrink:...}   消除环绕的空格成一个空格(>=4.14.0)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{quote:...}    引用一个参数宏作为参数，传递空字符或由空格分隔的字符串"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{lua:...}      用lua来展开"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{uncompress:...}   用文件方式展开，并检查文件是否压缩，支持未压缩、gzip、bzip3种"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{basename:...} "},{"type":"element","tag":"a","props":{"href":"http://man7.org/linux/man-pages/man1/basename.1.html","rel":["nofollow"]},"children":[{"type":"text","value":"basename"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"${dirname:...}  "},{"type":"element","tag":"a","props":{"href":"http://man7.org/linux/man-pages/man1/dirname.1.html","rel":["nofollow"]},"children":[{"type":"text","value":"dirname"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{suffix:...}    expand to suffix part of a file name"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{url2path:...} 转换url为本地路径"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{getenv:...}   "},{"type":"element","tag":"a","props":{"href":"http://man7.org/linux/man-pages/man3/getenv.3.html","rel":["nofollow"]},"children":[{"type":"text","value":"getenv"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{getconfdir:...}   rpm的home目录"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{S:...}        expand ... to "},{"type":"element","tag":"source","props":{},"children":[]},{"type":"text","value":" file name"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{P:...}        expand ... to "},{"type":"element","tag":"patch","props":{},"children":[{"type":"text","value":" file name"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%{F:...}        expand ... to "},{"type":"element","tag":"file","props":{},"children":[{"type":"text","value":" file name"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"默认变量地址 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"/usr/lib/rpm/macros"}]},{"type":"text","value":"   "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"/etc/rpm/"}]}]},{"type":"element","tag":"pre","props":{"code":"rpm --eval '<macro expression>'   # 查看宏\n\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"rpm --eval '<macro expression>'   # 查看宏\n\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"使用宏"}]},{"type":"element","tag":"pre","props":{"code":"%{<name>}       #直接展开成txt\n%<name> ...     #如果有参数则进行调用\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"%{<name>}       #直接展开成txt\n%<name> ...     #如果有参数则进行调用\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"eg"}]},{"type":"element","tag":"pre","props":{"code":"%define mymacro() (echo -n \"My arg is %1\" ; sleep %1 ; echo done.)\n%mymacro 5\n(echo -n \"My arg is 5\" ; sleep 5 ; echo done.)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"%define mymacro() (echo -n \"My arg is %1\" ; sleep %1 ; echo done.)\n%mymacro 5\n(echo -n \"My arg is 5\" ; sleep 5 ; echo done.)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"autoconf中的宏变量"}]},{"type":"element","tag":"pre","props":{"code":"    %_prefix            /usr\n    %_exec_prefix       %{_prefix}\n    %_bindir            %{_exec_prefix}/bin\n    %_sbindir           %{_exec_prefix}/sbin\n    %_libexecdir        %{_exec_prefix}/libexec\n    %_datadir           %{_prefix}/share\n    %_sysconfdir        %{_prefix}/etc\n    %_sharedstatedir    %{_prefix}/com\n    %_localstatedir     %{_prefix}/vars\n    %_libdir            %{_exec_prefix}/lib\n    %_includedir        %{_prefix}/include\n    %_oldincludedir     /usr/include\n    %_infodir           %{_prefix}/info\n    %_mandir            %{_prefix}/man\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"    %_prefix            /usr\n    %_exec_prefix       %{_prefix}\n    %_bindir            %{_exec_prefix}/bin\n    %_sbindir           %{_exec_prefix}/sbin\n    %_libexecdir        %{_exec_prefix}/libexec\n    %_datadir           %{_prefix}/share\n    %_sysconfdir        %{_prefix}/etc\n    %_sharedstatedir    %{_prefix}/com\n    %_localstatedir     %{_prefix}/vars\n    %_libdir            %{_exec_prefix}/lib\n    %_includedir        %{_prefix}/include\n    %_oldincludedir     /usr/include\n    %_infodir           %{_prefix}/info\n    %_mandir            %{_prefix}/man\n"}]}]},{"type":"element","tag":"h3","props":{"id":"files"},"children":[{"type":"text","value":"%files"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"指向需要在构建系统中打包进rpm中的文件列表。 这些文件都会被作为参数执行2次，第一次是构建系统的路径，第二次是安装到目标系统的路径"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"%files包含了一些可用的指令"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"明确配置文件、文档"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"检查文件的权限"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"控制pkg验证阶段的文件需要被检查的方面"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"消除一些创建%files列表时候的繁琐工作"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"具体包括"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%attr   ("},{"type":"element","tag":"mode","props":{},"children":[{"type":"text","value":","},{"type":"element","tag":"user","props":{},"children":[{"type":"text","value":","},{"type":"element","tag":"group","props":{},"children":[{"type":"text","value":")"}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%defattr ("},{"type":"element","tag":"file-mode","props":{},"children":[{"type":"text","value":","},{"type":"element","tag":"user","props":{},"children":[{"type":"text","value":","},{"type":"element","tag":"group","props":{},"children":[{"type":"text","value":","},{"type":"element","tag":"dir-mode","props":{},"children":[{"type":"text","value":")"}]}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%doc"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%config"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%ghost  rpm知道但不在pkg的文件，如log"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%docdir"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%dir    指定目录下的所有信息都属于pkg，不用衍生的打印目录下的信息"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"-f "},{"type":"element","tag":"file","props":{},"children":[{"type":"text","value":"   文件中的每一行都是文件路径"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%verify     验证特殊的文件，如设备文件\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"owner"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"group"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"mode"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"md5"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"size"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"maj"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"min"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"symlink"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"mtime"}]}]}]}]},{"type":"element","tag":"h3","props":{"id":"条件-conditionals"},"children":[{"type":"text","value":"条件 conditionals"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"条件包括"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%ifarch"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%ifnarch"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%ifos"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%ifnos"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%else"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"%endif"}]}]},{"type":"element","tag":"h2","props":{"id":"engine"},"children":[{"type":"text","value":"engine"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"根据上面的一些知识点 初步整理的engine的spec文件情况如下图"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"ovirt-engine-spec","src":"https://raw.githubusercontent.com/ShaneDean/file/a66e4024f1769b5dc16dde24d04dc443fdd768d6/blog/ovirt_engine_env/ovirt-engine-spec.png"},"children":[]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"前言","depth":2,"text":"前言"},{"id":"rpm","depth":2,"text":"rpm"},{"id":"spec","depth":2,"text":"spec","children":[{"id":"标签-tags","depth":3,"text":"标签 tags"},{"id":"脚本-script","depth":3,"text":"脚本 script"},{"id":"宏-macro","depth":3,"text":"宏 macro"},{"id":"files","depth":3,"text":"%files"},{"id":"条件-conditionals","depth":3,"text":"条件 conditionals"}]},{"id":"engine","depth":2,"text":"engine"}]}},"_type":"markdown","_id":"content:blog:ovirt:engine:spec.md","_source":"content","_file":"blog/ovirt/engine/spec.md","_extension":"md"}